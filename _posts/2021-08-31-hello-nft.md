---
layout: post
title: "Hello NFT"
subtitle: "Hello NFT"
description: "Ethereum NFT åˆé«”é©—"
author: VagrantPi
tags: Ethereum Blockchain
imgurl-fb: /public/img/index/ethrttock.jpg
imgurl: /public/img/index/smart-contract.png
imgalt: smart-contract 
---

<style>
  img[alt="etherrock0"] {
    width: 200px;
  }
</style>

## Intro

ç·Šæ¥è‘—ä¸Šæ¬¡çš„ [Hello Smart Contract](./2021-08-25-hello-smart-contract.md)ï¼Œ[Alchemy Doc](https://docs.alchemy.com/alchemy/) æ¥ä¸‹ä¾†çš„ç¯„ä¾‹ç‚º ERC 721

ä¹Ÿå°±æ˜¯ä»Šå¹´ç´…èµ·ä¾†çš„ NFT(Non-Fungible Token)ï¼Œè²“å’ªã€æ˜æ˜Ÿå¡ã€è—è¡“å“ã€ç”šè‡³æ˜¯çŸ³é ­ [Ether Rock](/public/img/index/ethrttock.jpg)ï¼ˆä¸‹åœ–ï¼‰ï¼Œéƒ½èƒ½æˆç‚º NFT

![etherrock0](https://etherrock.com/0.png)

ä¸€æ¨£ç‚ºè©²æ–‡ä»¶çš„å­¸ç¿’ç­†è¨˜ï¼Œè©³ç´°ç¯„ä¾‹å¯ä»¥åƒè€ƒ: [https://github.com/VagrantPi/hello-nft](https://github.com/VagrantPi/hello-nft)

è€Œæµç¨‹åŸºæœ¬ä¸Šä¸€ç¯‡å·®ä¸å¤šï¼Œä¸éé€™æ¬¡å¤šä½¿ç”¨åˆ°ä¸€å€‹ contracts library - [OpenZepplin](https://openzeppelin.com/)

> A library for secure smart contract development. Build on a solid foundation of community-vetted code.

å› æ­¤æˆ‘å€‘å¯ä»¥æ›´å®‰å…¨ã€ç°¡å–®çš„å»ºç«‹åˆç´„

å…ˆå®‰è£ä¸€ä¸‹

```
npm install @openzeppelin/contracts@3.1.0-solc-0.7
```

<br>

## ğŸ¨ æ–°å»ºåˆç´„

> Source: [ğŸ¨ How to Create an NFT](https://docs.alchemy.com/alchemy/tutorials/how-to-create-an-nft#step-1-connect-to-the-ethereum-network)

æ¥ä¸‹ä¾†çœ‹åˆ°åˆç´„çš„éƒ¨ä»½

```solidity
//Contract based on https://docs.openzeppelin.com/contracts/3.x/erc721
// SPDX-License-Identifier: MIT
pragma solidity ^0.7.3;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/utils/Counters.sol";
import "@openzeppelin/contracts/access/Ownable.sol";


contract MyNFT is ERC721, Ownable {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIds;

    // ç¬¬ä¸€å€‹åƒæ•¸ç‚º NFT åç¨±
    // ç¬¬äºŒå€‹åƒæ•¸ç‚º NFT's metadata
    constructor() public ERC721("MyNFT", "NFT") {}

    // ç¬¬ä¸€å€‹åƒæ•¸ç‚ºæ¥æ”¶è€… address
    // ç¬¬äºŒå€‹åƒæ•¸ç‚ºè©² NFT metadataï¼Œåç¨±ã€åœ–ç‰‡...ç­‰æè¿°ï¼Œä¸‹é¢æœƒæåˆ°
    function mintNFT(address recipient, string memory tokenURI)
        public onlyOwner
        returns (uint256)
    {
        _tokenIds.increment();

        uint256 newItemId = _tokenIds.current();
        _mint(recipient, newItemId);
        _setTokenURI(newItemId, tokenURI);

        return newItemId;
    }
}
```

- `@openzeppelin/contracts/token/ERC721/ERC721.sol`: å› ç‚ºéœ€è¦ç”¨åˆ° ERC721ï¼Œé€™é‚Šç›´æ¥ import å¾Œç›´æ¥å¯ä»¥ç¹¼æ‰¿ä½¿ç”¨ï¼Œç•¢ç«Ÿ ERC spec ä¹Ÿå·²ç¶“å®šç¾©å¥½ç›¸é—œæ¥å£äº†ï¼Œ[EIP-721: Non-Fungible Token Standard](https://eips.ethereum.org/EIPS/eip-721)
- `@openzeppelin/contracts/utils/Counters.sol`: é€™é‚Šä½¿ç”¨ Counters ä¾†çµ¦äºˆæ¯ä¸€å€‹ minted NFT å”¯ä¸€ IDï¼Œä¸¦è¿½è¹¤å…¶ç™¼è¡Œé‡
- `@openzeppelin/contracts/access/Ownable.sol`: è¨­å®š [access control](https://docs.openzeppelin.com/contracts/3.x/access-control) ä½¿å¾—åªæœ‰ smart contract çš„æ“æœ‰è€…æ‰æœ‰æ¬ŠåŠ› mint NFTï¼Œå¦‚æœéºé™¤æ‰ onlyOwner çš„è¨­å®šï¼Œé‚£ä»»ä½•äººéƒ½èƒ½ mint NFT

æ‰€ä»¥è©²åˆç´„ç°¡å–®ä¾†èªªå°±æ˜¯å»ºç«‹ä¸€å€‹å«åš `MyNFT`ï¼ŒSymbol ç‚º `NFT` çš„ ERC721ï¼Œå¯ä»¥é€é `mintNFT` æ–¹æ³•ä¾†é‘„é€ (mint) NFT

### deploy script

```javascript
async function main() {
   // Grab the contract factory 
   const MyNFT = await ethers.getContractFactory("MyNFT");

   // Start deployment, returning a promise that resolves to a contract object
   const myNFT = await MyNFT.deploy(); // Instance of the contract 
   console.log("Contract deployed to address:", myNFT.address);
}

main()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
```

æµç¨‹è·Ÿä¸Šä¸€ç¯‡ä¸€æ¨£ï¼Œcompile å¾Œ

```
npx hardhat compile
```

ç„¶å¾Œ deploy

```
npx hardhat run scripts/deploy.js --network ropsten
```

```
Contract deployed to address: 0xa1270bb0BFacb686cCbc3D89072bBD4d7743cA87
```

[https://ropsten.etherscan.io/address/0xa1270bb0bfacb686ccbc3d89072bbd4d7743ca87](https://ropsten.etherscan.io/address/0xa1270bb0bfacb686ccbc3d89072bbd4d7743ca87)

<br>

## ğŸª„é‘„é€  NFT

> Source: [ğŸª„How to Mint an NFT](https://docs.alchemy.com/alchemy/tutorials/how-to-create-an-nft/how-to-mint-a-nft)

å‘¼å«åˆç´„çš„ mintNFT ä¾†é‘„é€  NFTï¼Œå‘¼å«æ–¹æ³•å¯ä»¥åƒè€ƒä¸Šä¸€ç¯‡æ–‡ç« ï¼Œè€Œé€™é‚Šé‚„éœ€è¦å‚³å…¥ä¸€å€‹ tokenURI åƒæ•¸ï¼Œå…¶å…§å®¹ç‚º NFT Metadataï¼ŒæŒ‰é€  â€œERC721 Metadata JSON Schema

```json
{
    "title": "Asset Metadata",
    "type": "object",
    "properties": {
        "name": {
            "type": "string",
            "description": "Identifies the asset to which this NFT represents"
        },
        "description": {
            "type": "string",
            "description": "Describes the asset to which this NFT represents"
        },
        "image": {
            "type": "string",
            "description": "A URI pointing to a resource with mime type image/* representing the asset to which this NFT represents. Consider making any images at a width between 320 and 1080 pixels and aspect ratio between 1.91:1 and 4:5 inclusive."
        }
    }
}
```

è‡³å°‘é ˆåŒ…å« `name`, `description`, `image`ï¼Œæˆ‘å€‘æœƒä½¿ç”¨é€é [Pinata](https://www.pinata.cloud/) é€™å€‹ IPFSï¼ˆP2P ç¶²è·¯çš„å»ä¸­å¿ƒåŒ–æª”æ¡ˆç³»çµ±ï¼‰å…ˆä¸Šå‚³åœ–ç‰‡ï¼Œç„¶å¾Œåœ¨å°‡è©²æ ¼å¼çš„ json ä¸Šå‚³è‡³ IPFS

### ä¸Šå‚³åœ–ç‰‡è‡³ IPFS

![](/public/img/post/nft/pinata01.png)

ç„¶å¾Œè¤‡è£½è©²åœ–ç‰‡çš„ CIDï¼Œè©²åœ–ç‰‡çš„ä½ç½®ç‚º `https://gateway.pinata.cloud/ipfs/<CID>`

![](/public/img/post/nft/pinata02.png)

[https://gateway.pinata.cloud/ipfs/QmYqfs79uSDJzdMebdA7z5BhMzggm4HzZHMGbxkhRZMEBW](https://gateway.pinata.cloud/ipfs/QmYqfs79uSDJzdMebdA7z5BhMzggm4HzZHMGbxkhRZMEBW)

![](/public/img/post/nft/pinata03.jpg)


### å­˜æˆ NFT Metadata å¾Œå†æ¬¡ä¸Šå‚³

```json
{
  "attributes" : [ {
    "trait_type" : "Breed",
    "value" : "MeMe"
  }, {
    "trait_type" : "rank",
    "value" : "no. 1"
  } ],
  "description" : "the popular meme in 2021/08",
  "image" : "https://gateway.pinata.cloud/ipfs/QmYqfs79uSDJzdMebdA7z5BhMzggm4HzZHMGbxkhRZMEBW",
  "name" : "POPCAT data"
}
```

![](/public/img/post/nft/pinata04.png)

[https://gateway.pinata.cloud/ipfs/QmRYHRzgEt6jSGQutyVr3MqNFptsEaL4NMZUPRUQqZHPNf](https://gateway.pinata.cloud/ipfs/QmRYHRzgEt6jSGQutyVr3MqNFptsEaL4NMZUPRUQqZHPNf)


### å‘¼å«åˆç´„


```javascript
// ...
const nftContract = new web3.eth.Contract(contract.abi, contractAddress);

async function mintNFT(tokenURI) {
  const nonce = await web3.eth.getTransactionCount(PUBLIC_KEY, 'latest'); 

  // the transaction
  const tx = {
    'from': PUBLIC_KEY,
    'to': contractAddress,
    'nonce': nonce,
    'gas': 500000,
    'maxPriorityFeePerGas': 1999999987,
    'data': nftContract.methods.mintNFT(PUBLIC_KEY, tokenURI).encodeABI()
  };
  
  const signPromise = web3.eth.accounts.signTransaction(tx, PRIVATE_KEY);
  // ...
  });
}

mintNFT('https://gateway.pinata.cloud/ipfs/QmRYHRzgEt6jSGQutyVr3MqNFptsEaL4NMZUPRUQqZHPNf')
```

### Mint NFT

```
node mint-nft.js 
```

```
The hash of your transaction is:  0x6bac10518d8eb89e4c6ff535411b83316a6d52a6f529f9e2b2e75d60aab9b91f 
Check Alchemy's Mempool to view the status of your transaction!
```

[https://ropsten.etherscan.io/tx/0x6bac10518d8eb89e4c6ff535411b83316a6d52a6f529f9e2b2e75d60aab9b91f](https://ropsten.etherscan.io/tx/0x6bac10518d8eb89e4c6ff535411b83316a6d52a6f529f9e2b2e75d60aab9b91f)

æ­¤æ™‚çœ‹åˆç´„çš„é é¢å°±å¯ä»¥çœ‹åˆ°

![](/public/img/post/nft/nft01.png)

åˆ‡åˆ°è©²éŒ¢åŒ…é é¢ä¹Ÿå¯ä»¥çœ‹åˆ°æŒæœ‰çš„ ERC721 æ–°å¢äº†ä¸€å€‹ MyNFT

![](/public/img/post/nft/nft02.png)

### ä½¿ç”¨æ‰‹æ©Ÿç‰ˆ Metamask ä¾†æŸ¥çœ‹ NFT

![](/public/img/post/nft/nft03.jpg)

åœ¨æ”¶è—å“é‚£é‚ŠæŒ‰ä¸‹æ·»åŠ æ”¶è—å“ï¼Œç„¶å¾Œå°‡åˆç´„åœ°å€è·Ÿç™¼è¡Œç·¨è™Ÿè²¼ä¸Šå°±è¡Œ

é€™é‚Šçš„ `MyNFT #1` ç•¶åˆåœ¨ mint æ™‚ç›´æ¥è²¼ä¸Šåœ–ç‰‡ç¶²å€ã€‚è€Œä¸æ˜¯å¾Œä¾†ä¸Šå‚³çš„ NFT Metadata JSONï¼Œæ‰€ä»¥é¡¯ç¤ºä¸Šå°±ç„¡æ³•æ­£ç¢ºè®€å–

ä¸”å¦‚æœå¡«éŒ¯è³‡è¨Šä¹Ÿç„¡æ³•é¡¯ç¤º

![](/public/img/post/nft/nft04.jpg)

<br>

## ğŸª„ä½¿ç”¨ Ethers.js ä¾†é‘„é€  NFT

> [ğŸª„How to Mint an NFT with Ethers.js](https://docs.alchemy.com/alchemy/tutorials/how-to-create-an-nft/how-to-mint-an-nft-with-ethers#a-quick-reminder)

é€™é‚Šä½¿ç”¨ Ethers.js ä»£æ›¿ Web3 çš„æ–¹å¼å†åšä¸€æ¬¡ï¼Œä¸¦ä¸”ä½¿ç”¨åˆ° hardhat-waffle
å¥—ä»¶ä¾†æ¸¬è©¦åˆç´„ï¼Œç„¶å¾Œæ”¹ç”¨ TypeScript ä¾†é–‹ç™¼

### å®‰è£ TypeScript & hardhat-waffle

#### TypeScript

```
npm install --save-dev ts-node typescript
npm install --save-dev chai @types/node @types/mocha @types/chai
```

> [TypeScript Support](https://hardhat.org/guides/typescript.html#typescript-support)

å…¶ä»–é‚„æœ‰è¨­å®šæª”è¦å‰¯æª”åï¼Œæ–°å¢è¨­å®šç­‰ï¼Œé€™é‚Šè«‹çœ‹é€£çµï¼Œå°±ä¸å±•é–‹èªªæ˜äº†

#### hardhat-waffle

ç‚º HardHat å¥—ä»¶ï¼Œç”¨æ–¼æ™ºèƒ½åˆç´„æ¸¬è©¦

```
npm install --save-dev @nomiclabs/hardhat-waffle 'ethereum-waffle@^3.0.0' @nomiclabs/hardhat-ethers 'ethers@^5.0.0'
```

> [hardhat-waffle](https://hardhat.org/plugins/nomiclabs-hardhat-waffle.html)

### åˆ†åˆ¥å°‡ç”¨åˆ°çš„ç”¨åˆ°çš„åŠŸèƒ½å°è£èµ·ä¾†

```
mkdir lib
```

- `lib/contract.ts`

  ```typescript
  import { Contract, ethers } from "ethers";
  import { getContractAt } from "@nomiclabs/hardhat-ethers/internal/helpers";
  import { HardhatRuntimeEnvironment } from "hardhat/types";
  import { env } from "./env";
  import { getProvider } from "./provider";

  export function getContract(
    name: string,
    hre: HardhatRuntimeEnvironment
  ): Promise<Contract> {
    const WALLET = new ethers.Wallet(env("ETH_PRIVATE_KEY"), getProvider());
    return getContractAt(hre, name, env("NFT_CONTRACT_ADDRESS"), WALLET);
  }
  ```

- `lib/env.ts`

  ```typescript
  export function env(key: string): string {
    const value = process.env[key];
    if (value === undefined) {
      throw `${key} is undefined`;
    }
    return value;
  }
  ```

- `lib/provider.ts`

  é€™é‚Š provider ä½¿ç”¨ ropstenï¼ˆé è¨­æœƒæ˜¯ `mainnet`ï¼‰ï¼Œä¸¦è¨­å®šå¥½ Alchemy API Tokenï¼Œé€™é‚Šä¹Ÿæå…±å¤šç¨®é€£ç·šæ–¹æ¡ˆ [supported alternatives](https://docs.ethers.io/v5/api/providers/#providers-getDefaultProvider)

  ```typescript
  import { ethers } from "ethers";

  export function getProvider(): ethers.providers.Provider {
    return ethers.getDefaultProvider("ropsten", {
      alchemy: process.env.ALCHEMY_API_KEY,
    });
  }
  ```

- `wallet.ts`

  ```typescript
  import { ethers } from "ethers";
  import { env } from "./env";
  import { getProvider } from "./provider";

  export function getWallet(): ethers.Wallet {
    return new ethers.Wallet(env("ETH_PRIVATE_KEY"), getProvider());
  }
  ```

### å»ºç«‹ Hardhat tasks

å¯ä»¥å¯« Hardhat çš„ task ä¾†æ“´å¢ Hardhat æŒ‡ä»¤ä¾†å®Œæˆä¸€äº›è‡ªå‹•åŒ–çš„æ“ä½œ

ä¾‹å¦‚åœ¨è©²ç¯‡ç¯„ä¾‹å¾Œå¯¦ä½œçš„ `deploy` è·Ÿ `mint`

```
AVAILABLE TASKS:

  deploy-contract    Deploy NFT contract
  mint-nft      Mint an NFT
```

ä¸¦ä¸”å¯ä»¥é€šæœƒ help æŒ‡ä»¤ä¾†æŸ¥çœ‹èªªæ˜

```
$ npx hardhat help deploy-contract

Hardhat version 2.6.1

Usage: hardhat [GLOBAL OPTIONS] deploy-contract

deploy-contract: Deploy NFT contract

For global options help run: hardhat help
```

åœ¨æ ¹ç›®éŒ„æ–°å¢ `tasks`

```typescript
import { task, types } from "hardhat/config";
import { Contract } from "ethers";
import { TransactionResponse } from "@ethersproject/abstract-provider";
import { env } from "../lib/env";
import { getContract } from "../lib/contract";
import { getWallet } from "../lib/wallet";

task("deploy-contract", "Deploy NFT contract").setAction(async (_, hre) => {
  return hre.ethers
    .getContractFactory("MyNFT", getWallet())
    .then((contractFactory) => contractFactory.deploy())
    .then((result) => {
      process.stdout.write(`Contract address: ${result.address}`);
    });
});

task("mint-nft", "Mint an NFT")
  .addParam("tokenUri", "Your ERC721 Token URI", undefined, types.string)
  .setAction(async (params, hre) => {
    return getContract("MyNFT", hre)
      .then((contract: Contract) => {
        return contract.mintNFT(env("ETH_PUBLIC_KEY"), params.tokenUri, {
          gasLimit: 500_000,
        });
      })
      .then((tr: TransactionResponse) => {
        process.stdout.write(`TX hash: ${tr.hash}`);
      });
  });
```

```
$ npx hardhat deploy-contract 

Contract address: 0x6dA6416fC6E68Dcb2CF8d148f02FdA1A614c4327
```

[https://ropsten.etherscan.io/address/0x6dA6416fC6E68Dcb2CF8d148f02FdA1A614c4327](https://ropsten.etherscan.io/address/0x6dA6416fC6E68Dcb2CF8d148f02FdA1A614c4327)

```
$ npx hardhat mint-nft --token-uri https://gateway.pinata.cloud/ipfs/QmRYHRzgEt6jSGQutyVr3MqNFptsEaL4NMZUPRUQqZHPNf

TX hash: 0x38f64758b99b498372551d75fa09781408d40bd6f4daf842557580b95a929c34
```

[https://ropsten.etherscan.io/tx/0x38f64758b99b498372551d75fa09781408d40bd6f4daf842557580b95a929c34](https://ropsten.etherscan.io/tx/0x38f64758b99b498372551d75fa09781408d40bd6f4daf842557580b95a929c34)

### Testing

é€™è£¡å¤šå®‰è£äº†ä¸€äº›å·¥å…·ä¾†å¹«å¿™æ¸¬è©¦

```
npm install --save-dev sinon-chai sinon chai
```

- [sinon](https://sinonjs.org/) - Standalone test spies, stubs and mocks for JavaScript.
- [chai](https://www.chaijs.com/) - Assertion Library

> åƒè€ƒç¯„ä¾‹ï¼š[å–®å…ƒæ¸¬è©¦ï¼šMochaã€Chai å’Œ Sinon](https://cythilya.github.io/2017/09/17/unit-test-with-mocha-chai-and-sinon/)

```
mkdir test
```

- `test/test-helpers.ts`

  å…ˆå°‡æœƒç”¨åˆ°çš„éƒ¨å±¬åˆç´„è·ŸéŒ¢åŒ…å°è£èµ·ä¾†
  
  Note: åœ¨æ¸¬è©¦å®Œæˆå¾Œå‘¼å« `sinon.restore();` æ¢å¾©ï¼Œå¦å‰‡æœƒé€ æˆ sinon ä¿®æ”¹çš„å€¼æ±¡æŸ“åˆ°ä¸‹é¢çš„æ¸¬è©¦ï¼Œå› ç‚º test-doubles æŒçºŒå­˜åœ¨

  ```typescript
  import sinon from "sinon";
  import chai from "chai";
  import sinonChai from "sinon-chai";
  import { ethers as hardhatEthers, waffle } from "hardhat";
  import { Contract, Wallet } from "ethers";

  chai.use(sinonChai);

  afterEach(() => {
    sinon.restore();
  });

  export function deployTestContract(name: string): Promise<Contract> {
    return hardhatEthers
      .getContractFactory(name, getTestWallet())
      .then((contractFactory) => contractFactory.deploy());
  }

  export function getTestWallet(): Wallet {
    return waffle.provider.getWallets()[0];
  }
  ```

- `test/MyNFT.spec.ts`

  å°‡ç¶²è·¯ç’°å¢ƒæ›¿æ›æˆ waffleï¼Œä½¿åˆç´„å¯ä»¥è·‘åœ¨ Hardhat Network ä¸Šï¼Œè©²ç¶²è·¯ç‚º local çš„ï¼Œå¯ä»¥æ–¹ä¾¿æ¸¬è©¦åˆç´„
  `sinon.stub(provider, "getProvider").returns(waffle.provider);`
  

  ```typescript
  import { ethers, waffle } from "hardhat";
  import { Contract, Wallet } from "ethers";
  import { expect } from "chai";
  import { TransactionResponse } from "@ethersproject/abstract-provider";
  import sinon from "sinon";
  import { deployTestContract } from "./test-helper";
  import * as provider from "../lib/provider";

  describe("MyNFT", () => {
    const TOKEN_URI = "http://example.com/ip_records/42";
    let deployedContract: Contract;
    let wallet: Wallet;

    beforeEach(async () => {
      sinon.stub(provider, "getProvider").returns(waffle.provider);
      [wallet] = waffle.provider.getWallets();
      deployedContract = await deployTestContract("MyNFT");
    });

    async function mintNftDefault(): Promise<TransactionResponse> {
      return deployedContract.mintNFT(wallet.address, TOKEN_URI);
    }

    describe("mintNft", async () => {
      it("emits the Transfer event", async () => {
        await expect(mintNftDefault())
          .to.emit(deployedContract, "Transfer")
          .withArgs(ethers.constants.AddressZero, wallet.address, "1");
      });

      it("returns the new item ID", async () => {
        await expect(
          await deployedContract.callStatic.mintNFT(wallet.address, TOKEN_URI)
        ).to.eq("1");
      });

      it("increments the item ID", async () => {
        const STARTING_NEW_ITEM_ID = "1";
        const NEXT_NEW_ITEM_ID = "2";

        await expect(mintNftDefault())
          .to.emit(deployedContract, "Transfer")
          .withArgs(
            ethers.constants.AddressZero,
            wallet.address,
            STARTING_NEW_ITEM_ID
          );

        await expect(mintNftDefault())
          .to.emit(deployedContract, "Transfer")
          .withArgs(
            ethers.constants.AddressZero,
            wallet.address,
            NEXT_NEW_ITEM_ID
          );
      });

      it("cannot mint to address zero", async () => {
        const TX = deployedContract.mintNFT(
          ethers.constants.AddressZero,
          TOKEN_URI
        );
        await expect(TX).to.be.revertedWith("ERC721: mint to the zero address");
      });
    });

    describe("balanceOf", () => {
      it("gets the count of NFTs for this address", async () => {
        await expect(await deployedContract.balanceOf(wallet.address)).to.eq("0");

        await mintNftDefault();

        expect(await deployedContract.balanceOf(wallet.address)).to.eq("1");
      });
    });
  });
  ```

- `test/tasks.spec.ts`

  æ¸¬è©¦ Hardhat task

  ```typescript
  import { deployTestContract, getTestWallet } from "./test-helper";
  import { waffle, run } from "hardhat";
  import { expect } from "chai";
  import sinon from "sinon";
  import * as provider from "../lib/provider";

  describe("tasks", () => {
    beforeEach(async () => {
      sinon.stub(provider, "getProvider").returns(waffle.provider);
      const wallet = getTestWallet();
      sinon.stub(process, "env").value({
        ETH_PUBLIC_KEY: wallet.address,
        ETH_PRIVATE_KEY: wallet.privateKey,
      });
    });

    describe("deploy-contract", () => {
      it("calls through and returns the transaction object", async () => {
        sinon.stub(process.stdout, "write");

        await run("deploy-contract");

        await expect(process.stdout.write).to.have.been.calledWith(
          "Contract address: 0x610178dA211FEF7D417bC0e6FeD39F05609AD788"
        );
      });
    });

    describe("mint-nft", () => {
      beforeEach(async () => {
        const deployedContract = await deployTestContract("MyNFT");
        process.env.NFT_CONTRACT_ADDRESS = deployedContract.address;
      });

      it("calls through and returns the transaction object", async () => {
        sinon.stub(process.stdout, "write");

        await run("mint-nft", { tokenUri: "https://example.com/record/4" });

        await expect(process.stdout.write).to.have.been.calledWith(
          "TX hash: 0xf9088be65ad2ef73aafda6dc24a2925fc2cc0c5c8372e7e47db0778e2984785a"
        );
      });
    });
  });
  ```
  
```
$ npx hardhat test


  MyNFT
    mintNft
      âœ“ emits the Transfer event (236ms)
      âœ“ returns the new item ID
      âœ“ increments the item ID (132ms)
      âœ“ cannot mint to address zero (75ms)
    balanceOf
      âœ“ gets the count of NFTs for this address (78ms)

  tasks
    deploy-contract
    mint-nft


  7 passing (4s)
```

## çµèª

é€šé OpenZepplin å¯ä»¥å¾ˆç°¡å–®å°±å¯¦ä½œä¸€å€‹ ERC Spec çš„åˆç´„ï¼Œé€™é‚Šä¹Ÿé¡Œåˆ°äº†åˆç´„æ¸¬è©¦çš„éƒ¨ä»½

è€Œ [https://github.com/VagrantPi/hello-nft](https://github.com/VagrantPi/hello-nft) çš„ [ä½¿ç”¨ Ethers.js ä¾†é‘„é€  NFT](#ä½¿ç”¨-ethersjs-ä¾†é‘„é€ -nft) å…§å®¹æœ‰äº›èª¿æ•´

æ¯”å¦‚ task test ä¸­ `mint-nft` å¾Œçš„ TX hashï¼Œé€™é‚Šä¸ç¢ºå®šæ˜¯å¦‚ä½•é å…ˆçŸ¥é“ TX hash çš„ï¼Œæˆ‘è·‘æ¸¬è©¦å‡ºä¾†çš„ Hash æœƒè·Ÿ [How to Mint an NFT with Ethers.js - Step 4: Create tests](https://docs.alchemy.com/alchemy/tutorials/how-to-create-an-nft/how-to-mint-an-nft-with-ethers#step-4-create-tests) ä¸åŒ

é‚„æœ‰åœ¨ `tasks/nft.ts` ä¸­çš„ `mint-nft`

```diff
task("mint-nft", "Mint an NFT")
  .addParam("tokenUri", "Your ERC721 Token URI", undefined, types.string)
+  .setAction(async (params, hre) => {
-  .setAction(async (tokenUri, hre) => {
    return getContract("MyNFT", hre)
      .then((contract: Contract) => {
+        return contract.mintNFT(env("ETH_PUBLIC_KEY"), params.tokenUri, {
-        return contract.mintNFT(env("ETH_PUBLIC_KEY"), tokenUri, {
          gasLimit: 500_000,
        });
      })
      .then((tr: TransactionResponse) => {
        process.stdout.write(`TX hash: ${tr.hash}`);
      });
  });
```

ä¸ç„¶æœƒé€ æˆ tokenURI æ˜¯ç©ºçš„

![](/public/img/post/nft/bug.png)
